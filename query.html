<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BCTP - è¡Œç‚ºå¾ŒæœæŸ¥è©¢</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›¡ï¸</text></svg>">
</head>
<body>
<header>
<div class="container">
<h1>BCTP</h1>
<p>éœ¸å‡Œè¡Œç‚ºå¾Œæœé€æ˜åŒ–è³‡è¨Šå¹³å°</p>
</div>
</header>

<main>
<div class="container">
<div id="main-content-wrapper" style="display:none;">
<div class="main-layout-grid">

  <!-- å·¦å´ å‹¾é¸å€ -->
  <div class="filter-panel">
    <h2>æ­¥é©Ÿä¸€ï¼šè¡Œç‚ºå‹¾é¸</h2>
    <p>å‹¾é¸è§¸ç™¼æ³•å¾‹å¾Œæœçš„è¡Œç‚ºï¼ŒæŸ¥çœ‹å°æ‡‰çš„æ³•å¾‹å¾Œæœèˆ‡æ¡ˆä¾‹ã€‚</p>
    <div class="checkbox-group" id="behavior-filters">
      <label><input type="checkbox" name="behavior" value="physical-injury" data-type="2"> è‚¢é«”æ¨æ‰“</label>
      <label><input type="checkbox" name="behavior" value="online-slander" data-type="3"> ç¶²è·¯æ•£å¸ƒè¬ è¨€</label>
      <label><input type="checkbox" name="behavior" value="money-extortion" data-type="4"> å¨è„…å–è²¡</label>
      <label><input type="checkbox" name="behavior" value="psychological-damage" data-type="5"> å¯†é›†è¨Šæ¯é¨·æ“¾</label>
      <label><input type="checkbox" name="behavior" value="sexual-bullying" data-type="6"> æ€§éœ¸å‡Œ</label>
    </div>
  </div>

  <!-- ä¸­é–“ æ³•æ¢å€ -->
  <div class="results-panel">
    <h2>æ­¥é©ŸäºŒï¼šå¾Œæœè­¦ç¤º (å³æ™‚äº’å‹•)</h2>
    <p>è«‹åœ¨ä¸Šæ–¹å‹¾é¸è¡Œç‚ºæ¨™ç±¤ï¼Œçµæœå°‡å³æ™‚é¡¯ç¤ºç›¸é—œæ³•å¾‹æ¢æ–‡ã€‚</p>
    <div id="results-area">
      <p id="initial-loading-status" class="loading-message" style="text-align:center; font-size:1.1em;">è¼‰å…¥æ³•å¾‹è³‡æ–™ä¸­...</p>
    </div>
  </div>

  <!-- å³å´ æ¡ˆä¾‹å€ -->
  <div class="case-panel">
    <h2>æ­¥é©Ÿä¸‰ï¼šç›¸é—œæ¡ˆä¾‹</h2>
    <p>è«‹åœ¨ä¸Šæ–¹å‹¾é¸è¡Œç‚ºæ¨™ç±¤ï¼ŒæŸ¥çœ‹ç›¸é—œæ–°èæ¡ˆä¾‹ã€‚</p>
    <div id="case-area"></div>
  </div>

</div>

<!-- åº•éƒ¨æŒ‰éˆ• -->
<div class="button-footer">

  <button class="btn-animated btn-gray" onclick="location.href='index.html'">
    <span class="default-text">â† è¿”å›é¦–é </span>
    <span class="hover-text">è¿”å›é¦–é </span>
  </button>

  <button id="next-btn" class="btn-animated btn-green">
    <span class="default-text">ä¸‹ä¸€æ­¥ï¼šæ¸¬é©— â†’</span>
    <span class="hover-text">éœ¸å‡Œè¡Œç‚ºæ¸¬é©—</span>
  </button>

</div>

</div>
</div>
</main>

<footer>
<p>BCTP (Bullying Consequence Transparency Platform)</p>
</footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const STATUTES_URL = 'https://raw.githubusercontent.com/voidSTU/BCTP/main/LawJson.json';
  const CASES_URL = 'https://raw.githubusercontent.com/voidSTU/BCTP/main/CaseJson.json';

  const mainContentWrapper = document.getElementById('main-content-wrapper');
  const initialLoadingStatus = document.getElementById('initial-loading-status');
  const filterContainer = document.getElementById('behavior-filters');
  const resultsArea = document.getElementById('results-area');
  const caseArea = document.getElementById('case-area');
  const checkboxes = filterContainer.querySelectorAll('input[type="checkbox"]');
  const nextBtn = document.getElementById('next-btn');

  let lawData = { related_statutes_segmented: [], LawType_Mapping: {}, cases: [] };
  const FATAL_ERROR_MESSAGE = 'ç¶²ç«™éŒ¯èª¤ï¼šæ ¸å¿ƒè³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œå³å°‡è¿”å›é¦–é ã€‚';

  async function loadLawData() {
    try {
      const [statutesResponse, casesResponse] = await Promise.all([
        fetch(STATUTES_URL),
        fetch(CASES_URL)
      ]);

      const statutesData = await statutesResponse.json();
      const casesData = await casesResponse.json();

      lawData.related_statutes_segmented = statutesData.related_statutes_segmented || [];
      lawData.LawType_Mapping = statutesData.LawType_Mapping || {};
      lawData.cases = Array.isArray(casesData.news) ? casesData.news : [];

      initialLoadingStatus.remove();
      mainContentWrapper.style.display = 'block';

      updateResults();
    } catch (error) {
      alert(FATAL_ERROR_MESSAGE);
      window.location.href = 'index.html';
    }
  }

  function getLawTypeLabel(law) {
    if (law.ReplenishType === 1) return `âš  ${lawData.LawType_Mapping["1"]} (å»ºè­°å’Œè§£/è³ å„Ÿ)`;
    if (law.LawType === 0) return `ğŸ›¡ï¸ ${lawData.LawType_Mapping["0"]}`;
    return `ğŸ”— ${lawData.LawType_Mapping[String(law.LawType)] || 'ç›¸é—œæ³•æ¢'}`;
  }

  function createLawCard(lawGroup) {
    const card = document.createElement('div');
    card.className = `law-card ${lawGroup.isSupplementCategory ? 'replenish-content' : ''}`;

    let html = `<h3 class="law-num-title">${lawGroup.LawNum}</h3>`;
    html += `<p class="law-details"><strong>æ¢æ–‡è©³æƒ…ï¼š</strong> ${lawGroup.LawDetails}</p>`;

    html += `<ul class="combined-relevance-list">`;
    lawGroup.combinedNotes.forEach(note => {
      html += `<li><strong>${getLawTypeLabel(note)}ï¼š</strong> ${note.RelevanceNote}</li>`;
    });
    html += `</ul>`;

    card.innerHTML = html;
    return card;
  }

  function createCaseCard(caseItem) {
    const card = document.createElement('div');
    card.className = 'case-card';
    let html = `<h4 class="case-title">${caseItem.newsTitle || 'ç„¡æ¡ˆä¾‹æ¨™é¡Œ'}</h4>`;
    html += `<p class="case-content"><strong>äº‹ä»¶ç¶“éï¼š</strong> ${caseItem.newscontent || 'ç„¡äº‹ä»¶ç¶“é'}</p>`;
    if (caseItem.source) html += `<p class="case-source"><strong>æ–°èä¾†æºï¼š</strong> <a href="${caseItem.source}" target="_blank">é»æ“ŠæŸ¥çœ‹</a></p>`;

    if (caseItem.videoconnection) {
      const youtubeMatch = caseItem.videoconnection.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|\w+\?v=)|youtu\.be\/)([\w-]+)/);
      const vimeoMatch = caseItem.videoconnection.match(/(?:vimeo\.com\/)(\d+)/);
      if (youtubeMatch && youtubeMatch[1]) {
        html += `<div class="video-container"><iframe src="https://www.youtube.com/embed/${youtubeMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
      } else if (vimeoMatch && vimeoMatch[1]) {
        html += `<div class="video-container"><iframe src="https://player.vimeo.com/video/${vimeoMatch[1]}" frameborder="0" allowfullscreen></iframe></div>`;
      } else {
        html += `<p class="case-video"><strong>ç›¸é—œå½±ç‰‡ï¼š</strong> <a href="${caseItem.videoconnection}" target="_blank">é»æ“ŠæŸ¥çœ‹å½±ç‰‡</a></p>`;
      }
    }

    card.innerHTML = html;
    return card;
  }

  function updateResults() {
    resultsArea.innerHTML = '';
    caseArea.innerHTML = '';

    const checkedBoxes = [...checkboxes].filter(cb => cb.checked);
    if (checkedBoxes.length === 0) {
      /*
      resultsArea.innerHTML = '<p class="note">è«‹å‹¾é¸å·¦å´è¡Œç‚ºä»¥æŸ¥çœ‹å°æ‡‰æ³•å¾‹å¾Œæœã€‚</p>';
      */
      return;
    }

    const selectedLawTypes = checkedBoxes.map(cb => Number(cb.dataset.type));
    localStorage.setItem('selectedQuestionTypes', JSON.stringify(selectedLawTypes));

    const grouped = {};
    lawData.related_statutes_segmented.forEach(law => {
      const shouldShow = 
        (law.LawType >= 2 && law.LawType <= 6 && selectedLawTypes.includes(law.LawType)) ||
        law.LawType === 0 ||
        law.LawType === 1;

      if (!shouldShow) return;

      const key = law.LawNum;
      if (!grouped[key]) {
        grouped[key] = {
          LawNum: law.LawNum,
          LawDetails: law.LawDetails,
          isSupplementCategory: law.LawType === 1 || law.ReplenishType === 1,
          combinedNotes: []
        };
      }

      grouped[key].combinedNotes.push({
        LawType: law.LawType,
        RelevanceNote: law.RelevanceNote,
        ReplenishType: law.ReplenishType
      });
    });

    Object.values(grouped).forEach(g => resultsArea.appendChild(createLawCard(g)));

    const caseList = lawData.cases.filter(caseItem =>
      selectedLawTypes.includes(Number(caseItem.newsType))
    );

    if (caseList.length === 0) {
      caseArea.innerHTML = '<p class="note">ç›®å‰æ²’æœ‰èˆ‡æ‰€é¸è¡Œç‚ºç›¸é—œçš„å…¬é–‹æ¡ˆä¾‹ã€‚</p>';
    } else {
      caseList.forEach(caseItem => caseArea.appendChild(createCaseCard(caseItem)));
    }
  }

  checkboxes.forEach(cb => cb.addEventListener('change', updateResults));

  nextBtn.addEventListener('click', () => {
    const checked = [...checkboxes].filter(cb => cb.checked);
    if (checked.length === 0) {
      alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹è¡Œç‚ºï¼');
      return;
    }
    window.location.href = 'quiz.html';
  });

  loadLawData();
});
</script>

</body>
</html>
